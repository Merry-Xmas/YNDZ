<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8 gb2312">
	<title>视频数据管理</title>

	<link rel="stylesheet" type="text/css" href="js/Interface/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="js/Interface/themes/icon.css">
	<script type="text/javascript" src="js/Interface/jquery.min.js"></script>
	<script type="text/javascript" src="js/Interface/jquery.easyui.min.js"></script>

	<script type="text/javascript" src="js/businessCommon.js" ></script>
	<script type="text/javascript" src="js/plupload/plupload.full.min.js" ></script>
    <script type="text/javascript" src="js/moment.js" ></script>

    <style>
    	html,body{height:99%;}
        .progress{
            height: 10px;
            background: #333;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 15px;
        }
        .progress .progress-bar{
            position: relative;
            -webkit-animation: animate-positive 2s;
            animation: animate-positive 2s;
        }
        .progress .progress-bar:after{
            content: "";
            display: inline-block;
            width: 9px;
            background: #fff;
            position: absolute;
            top: -10px;
            bottom: -10px;
            right: -5px;
            z-index: 1;
            transform: rotate(35deg);
        }
        .progress .progress-value{
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            position: absolute;
            top: -30px;
            right: -20px;
        }
        @-webkit-keyframes animate-positive{
            0%{ width: 0; }
        }
        @keyframes animate-positive {
            0%{ width: 0; }
        }

        #mydialog select {  
            width: 48.5%;  
            height: 105px;  
            outline: none;  
            border: 1px solid #95B8E7;
            border-radius: 5px;  
            position: absolute;
            left: 5px;
            top: 35px;
            z-index: 99;
        }  
        #mydialog input {  
            width: 48.5%;  
            line-height: 22px;  
            height: 22px;  
            border: 1px solid #95B8E7;  
            border-radius: 5px;
        }  
    </style>

    <script type="text/javascript" language="javascript">
    $(document).ready(function(){
    	loadDatagrid();
    });
    
    //新增视频数据
	function do_add(){
		do_open("http://localhost:8080/waf/VideoInfoAction.do?method=add", "_blank", 665, 280);
	}
	
	//删除视频数据
	function do_del(row){
		var rows = $('#VideoInfo').datagrid('getSelections');
		if (rows.length > 0) {
			if(confirm("您确定要删除该记录吗？")){
				for(var i=0; i<rows.length; i++){
					$.ajax
					({ 
						type: "GET", 
						url: "http://localhost:8080/waf/VideoInfoAction.do?method=delete&ID=" + rows[i].ID
					})
				}
				//alert("删除成功");
				loadDatagrid();
			}
		}
	}
	
	//查询视频数据
    function loadDatagrid() {
    	$('#VideoInfo').datagrid('loadData', { total: 0, rows: [] });
    	$.ajax
		({ 
			type: "GET", 
			url: "http://localhost:8080/waf/VideoInfoAction.do?method=queryAll",
			success: function(info)
			{ 	
                var data = [];
				var obj = eval("("+info+")");
				for(var i=0; i<obj.length; i++){
                    var startTime = "";
                    if (obj[i].STARTTIME != null) 
                        startTime = moment(new Date(obj[i].STARTTIME.time)).format('YYYY/MM/DD HH:mm:ss');

                    var endTime = "";
                    if (obj[i].ENDTIME != null) 
                        endTime = moment(new Date(obj[i].ENDTIME.time)).format('YYYY/MM/DD HH:mm:ss');

                    var isConvert = "";
                    switch (obj[i].ISCONVERT){
                        case 0: isConvert="未转换"; break;
                        case 1: isConvert="待转换"; break;
                        case 2: isConvert="已转换"; break;
                    }
                    var row = {"ID":obj[i].ID,"CID":obj[i].CID,"VIDEONAME":obj[i].VIDEONAME,
                        "PATH":obj[i].PATH,"STARTTIME":startTime,
                        "ENDTIME":endTime,"LENGTH":obj[i].LENGTH,
                        "DETAIL":obj[i].DETAIL,"ISCONVERT":isConvert};

                    data.push(row);
				}

                function pagerFilter(data){
                    if (typeof data.length == 'number' && typeof data.splice == 'function'){    // is array
                        data = {
                            total: data.length,
                            rows: data
                        }
                    }
                    var dg = $(this);
                    var opts = dg.datagrid('options');
                    var pager = dg.datagrid('getPager');
                    pager.pagination({
                        onSelectPage:function(pageNum, pageSize){
                            opts.pageNumber = pageNum;
                            opts.pageSize = pageSize;
                            pager.pagination('refresh',{
                                pageNumber:pageNum,
                                pageSize:pageSize
                            });
                            dg.datagrid('loadData',data);
                        }
                    });
                    if (!data.originalRows){
                        data.originalRows = (data.rows);
                    }
                    var start = (opts.pageNumber-1)*parseInt(opts.pageSize);
                    var end = start + parseInt(opts.pageSize);
                    data.rows = (data.originalRows.slice(start, end));
                    return data;
                }
                
                $(function(){
                    $('#VideoInfo').datagrid({loadFilter:pagerFilter}).datagrid('loadData', data);
                    $('#VideoInfo').datagrid('getPager').pagination({  
                        pageSize: 20,  
                        pageNumber: 1,  
                        pageList: [10, 20, 30, 40, 50],  
                        beforePageText: '第',//页数文本框前显示的汉字   
                        afterPageText: '页    共 {pages} 页',  
                        displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'  
                   });
                });

                loadRel();
            }
		});
    }

    function loadRel() {
        $.ajax
        ({ 
            type: "GET", 
            url: "http://localhost:8080/waf/CameraInfoAction.do?method=queryAll",
            success: function(CameraInfo){
                var obj = eval("("+CameraInfo+")");

                var rows = $("#VideoInfo").datagrid("getRows");
                for(var i=0;i<rows.length;i++){
                    for (var j=0;j<obj.length;j++) {
                        if (rows[i].CID == obj[j].ID) {
                            $('#VideoInfo').datagrid('updateRow', {
                                index: i,
                                row: { 
                                    CID: obj[j].NAME 
                                }  
                            })
                        }
                    }
                }
            }
        })
    }

    function formatOper(val,row,index){  
       	return "<a href='#'' onclick='do_edit("+row.ID+")'>修改</a> <a href='#'' onclick='do_abs("+row.ID+")'>查看摘要信息</a>";  

	}
	
	//编辑视频数据
	function do_edit(ID){
		if(ID != null);
			do_open("http://localhost:8080/waf/VideoInfoAction.do?method=edit&ID=" + ID, "_blank", 665, 280);
	}

    //查看摘要详情
    function do_abs(ID){
        if(ID != null);
            do_open("http://localhost:8080/waf/VideoInfoAction.do?method=abstractInfo&ID=" + ID, "_blank", 665, 280);
    }

    //弹出导入对话框
    function upload() {
        refresh();
        
        var selectObj = document.getElementById("typenum");
        var options = "";
        $.ajax
        ({ 
            type: "GET", 
            url: "http://localhost:8080/waf/CameraInfoAction.do?method=queryAll",
            success: function(sModelInfo)
            {
                var obj = eval("("+sModelInfo+")");
                for(var i=0; i<obj.length; i++){
                    options += "<option value=\""+ obj[i].ID +"\">"+ obj[i].NAME +"</option>";
                }
                selectObj.innerHTML=options;

                loadSelect();

                $('#mydialog').dialog({  
                    title: "上传视频" 
                });
                $('#mydialog').show();
            }
        });
    }
    
    //加载关联摄像头下拉框选项
    var TempArr=[];//存储option  
    function loadSelect(){  
        /*先将数据存入数组*/  
        $("#typenum option").each(function(index, el) {  
            TempArr[index] = $(this).text();  
        });  
        $(document).bind('click', function(e) {    
            var e = e || window.event; //浏览器兼容性     
            var elem = e.target || e.srcElement;    
            while (elem) { //循环判断至跟节点，防止点击的是div子元素     
                if (elem.id && (elem.id == 'typenum' || elem.id == "makeupCo")) {    
                    return;    
                }    
                elem = elem.parentNode;    
            }    
            $('#typenum').css('display', 'none'); //点击的不是div或其子元素     
        });    
    }
      
    function changeF(this_) {  
        $(this_).prev("input").val($(this_).find("option:selected").text());  
        $("#typenum").css({"display":"none"});  
    }  
    function setfocus(this_){  
        $("#typenum").css({"display":""});  
    }  
      
    function setinput(this_){  
        var select = $("#typenum");  
        select.html("");  
        for(i=0;i<TempArr.length;i++){  
            //若找到以txt的内容开头的，添option  
            if(TempArr[i].substring(0,this_.value.length).indexOf(this_.value)==0){  
                var option = $("<option></option>").text(TempArr[i]);  
                select.append(option);  
            }  
        }  
    } 

    function do_con(){
        var rows = $('#VideoInfo').datagrid('getSelections');
        if (rows.length > 0) {
            for(var i=0; i<rows.length; i++){
                if (rows[i].ISCONVERT=="未转换") {
                    $.ajax
                    ({ 
                        type: "GET", 
                        url: "http://localhost:8080/waf/VideoInfoAction.do?method=con&ID=" + rows[i].ID
                    })
                }
            }
            loadDatagrid();
        }else{
            alert("请选择要转换摘要的视频！");
        }
    }
	</script>
</head>
<body style="overflow:scroll;overflow-x:hidden;">
    <table class="easyui-datagrid" id="VideoInfo" style="width:100%"
        data-options="fit:true,collapsible:true,scrollbarSize:0,fitColumns:true,toolbar:'#tb',pagination:'#pagination'">
		<thead>
			<tr>
				<th field="ck" checkbox="true"></th>
				<th data-options="field:'ID',hidden:'true'">ID</th>
				<th data-options="field:'CID'" width="8%">关联摄像头</th>
				<th data-options="field:'VIDEONAME'" width="10%">视频名称</th>
				<th data-options="field:'PATH'" width="15%">视频本地存放地址</th>
				<th data-options="field:'STARTTIME'" width="12%">起始拍摄时间</th>
				<th data-options="field:'ENDTIME'" width="12%">终止拍摄时间</th>
				<th data-options="field:'LENGTH'" width="10%">拍摄时长</th>
				<th data-options="field:'DETAIL'" width="10%">视屏描述</th>
				<th data-options="field:'ISCONVERT'" width="10%">转换摘要状态</th>
                <th data-options="field:'operating',formatter:formatOper" width="13%">操作</th>
      		</tr>
		</thead>
	</table>

	<div id="tb" style="padding:5px;">
		<a class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="upload()">导入</a>
		<a class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="do_add()">新增</a>
		<a class="easyui-linkbutton" data-options="iconCls:'icon-clear',plain:true" onclick="do_del()">删除</a>
        <a class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true" onclick="do_con()">转换摘要</a>
	</div>

  	<div id="mydialog" style="display:none;width:420px;height:233px;overflow: hidden;"> 
            <div style="width:410px;padding: 5px;">
                <input type="text" name="makeupCo" id="makeupCo" class="makeinp" onfocus="setfocus(this)" oninput="setinput(this);" placeholder="请选择关联的摄像头                v"></input>  
                <select name="makeupCoSe" id="typenum" onchange="changeF(this)" size="10" style="display:none;"></select>  
                <a id="browse" class="easyui-linkbutton" data-options="iconCls:'icon-add'">选择文件</a>
               
                <a id="start_upload" class="easyui-linkbutton" data-options="iconCls:'icon-ok'" onclick="uploader.start();">开始上传</a>
                <a class="easyui-linkbutton" data-options="iconCls:'icon-reload'" onclick="refresh()"></a>
            </div>
            <br/>
            <div id="filelist" style="width:390px;padding: 5px"></div>
	</div>

	<script>
        // 实例化一个plupload上传对象  
        var uploader = new plupload.Uploader({  
            //这个是选择文件的button  
            browse_button : 'browse',   
            //服务器端的上传地址  
            url : 'http://localhost:8080/waf/UploadAction.do?method=uploadFile',   
            filters: {
    			mime_types : [{ title : "Video files", extensions : "mp4,avi,dav" }],
    			prevent_duplicates : true //不允许选取重复文件
    		}
        });      
        //在实例对象上调用init()方法进行初始化  
        uploader.init();  
          
        //文件添加时，在容器里显示待上传的文件列表  
        uploader.bind('FilesAdded',  
            function(uploader, files) {  
                for (var i in files) {  
                    //在页面迭代显示                      
                    $('#filelist').append('<input type="hidden" name="attachmentId" id="id'+files[i].id+'"/>'+files[i].name + ' (' + plupload.formatSize(files[i].size) + ')<br/><br/><div class="progress"><div id="'+files[i].id+'pro" class="progress-bar" style="width:0%; background:#97c513;"><div class="progress-value" ></div></div></div>');  
                }  
            }  
        );  
        //文件上传进度显示  
        uploader.bind('UploadProgress',  
                function(uploader, file) {  
                    // $('#'+file.id).html("   "+file.percent + "%");  
                    document.getElementById(file.id + "pro").style.width = file.percent+"%";
                    document.getElementById(file.id + "pro").innerHTML = file.percent + "%";
                }  
        );  


        uploader.bind('BeforeUpload',
            function(uploader, file) {
                var CID = $('#typenum option:selected').val();
                if (CID == null) {CID = ""}
                var fileDate = moment(new Date(file.lastModifiedDate)).format('MM/DD/YYYY HH:mm:ss')
                uploader.settings.url = "http://localhost:8080/waf/UploadAction.do?method=uploadFile&CID=" + CID + "&fileDate=" + fileDate;
            }
        );

        uploader.bind('Error',
            function(uploader, err) {
                if (err.message == "Duplicate file error.") {
                    alert("不允许选取重复文件!");
                }
                loadDatagrid();
            }
        );

        var successCount = 0,failCount = 0;
        // 全部完成后的事件  
        uploader.bind('UploadComplete',  
            function(uploader, files,result) {  
                loadDatagrid();
                alert("上传情况：\n" + successCount + "个文件上传成功！\n"+ failCount +"个文件上传失败！");
                refresh();
                successCount = failCount = 0;
            }  
        );

        //单个文件上完成后事件  
        uploader.bind('FileUploaded',  
            function(uploader, file,result) { 

                var receive = JSON.stringify(result.response);
                if (receive == "null") {
                    successCount++;
                    document.getElementById(file.id + "pro").innerHTML = "上传成功！";
                }else{
                    failCount++;
                    var start= receive.indexOf("(") + 3;
                    var end =  receive.indexOf(")") - 2;
                    var info = receive.substring(start,end);
                    document.getElementById(file.id + "pro").innerHTML = info; 
                    document.getElementById(file.id + "pro").style.background = "red";
                    document.getElementById(file.id + "pro").style.color = "#fff";
                }
            } 
        );  

        function refresh(){
            var filelist = document.getElementById("filelist");
            filelist.innerHTML="";

            while(uploader.files.length > 0){
                uploader.removeFile(uploader.files[0]);
            }
        }
	</script>
</body>
</html>